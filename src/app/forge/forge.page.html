<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>
      <div class="flex-space-between scrollable-vert">
        <div class="position-relative pointer" (click)="openBuildingUpgradeModal()">
          Forge L{{buildingService.getBuilding(buildingType).level}}
          <div class="upgrade-bubble {{buildingService.getUpgradeCss(buildingType)}}">!</div>
        </div>
        <div class="flex-center">
          <img class="ml-05 mr-05 resource-icon pointer" src="assets/icon/info.png" (click)="showUpgradeInfo()">
          <ion-button size="small" fill="clear" color="dark" (click)="close()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </div>
      </div>
    </ion-title>
  </ion-toolbar>
</ion-header>

<div *ngIf="saving" class="loading-indicator"><img src="assets/icon/logo.png" alt="" class="logo"></div>
<looted></looted>
<ion-content>
  <ion-card>
    <ion-card-content>
      <div class="flex-space-between font-small">
        <div class="flex">{{model.resources.wood}}/{{model.resources.woodMax}}
          <ion-img src="assets/icon/resources/WOOD.png" class="resource-icon"></ion-img>
        </div>
        <div class="flex">{{model.resources.brownCoal}}/{{model.resources.brownCoalMax}}
          <ion-img src="assets/icon/resources/BROWN_COAL.png" class="resource-icon"></ion-img>
        </div>
        <div class="flex">{{model.resources.blackCoal}}/{{model.resources.blackCoalMax}}
          <ion-img src="assets/icon/resources/BLACK_COAL.png" class="resource-icon"></ion-img>
        </div>
        <div class="flex">{{model.resources.coins}}
          <ion-img src="assets/icon/resources/COINS.png" class="resource-icon"></ion-img>
        </div>
        <div class="flex">{{model.resources.rubies}}
          <ion-img src="assets/icon/resources/RUBIES.png" class="resource-icon"></ion-img>
        </div>
      </div>
      <div class="flex-space-between">
        <div>Modify gear with max {{model.progress.gearModificationRarity}} stars</div>
        <div>Breakdown gear with max {{model.progress.gearBreakDownRarity}} stars</div>
      </div>
    </ion-card-content>
  </ion-card>
  <ion-card>
    <ion-card-content>
      <div class="flex">
        <div class="width-60 flex-start">Type</div>
        <div class="flex-space-between flex-grow flex-wrap">
          <img *ngFor="let type of enumService.getGearTypes()" src="assets/img/sets/default_{{type}}.png" class="resource-icon pointer mt-1 mr-1" (click)="toggleGearType(type)" [class.black-border]="gearType == type">
        </div>
      </div>
      <div class="mt-2 flex">
        <div class="width-60 flex-start">Quality</div>
        <div class="flex-space-between flex-grow flex-wrap">
          <div *ngFor="let qual of allQualities" class="pointer mt-1 mr-1" [class.text-selected]="qualities.indexOf(qual) != -1" (click)="toggleQuality(qual)">{{converter.readableIdentifier(qual)}}</div>
        </div>
      </div>
      <div class="mt-2 flex">
        <div class="width-60 flex-start">Sets</div>
        <div class="flex-space-between flex-grow flex-wrap">
          <img *ngFor="let set of enumService.getGearSets()" src="assets/icon/gear/{{set}}.png" (click)="toggleSet(set)" class="medium-icon pointer mt-1 mr-1" [class.small-icon-selected]="selectedSet === set">
        </div>
      </div>
      <div class="mt-2 flex">
        <div class="width-60 flex-start">Stars</div>
        <div class="flex-space-between flex-grow flex-wrap">
          <div class="pointer mt-1 mr-1" [class.text-selected]="showSimple" (click)="showSimple = !showSimple">Simple</div>
          <div class="pointer mt-1 mr-1" [class.text-selected]="showCommon" (click)="showCommon = !showCommon">Common</div>
          <div class="pointer mt-1 mr-1" [class.text-selected]="showUncommon" (click)="showUncommon = !showUncommon">Uncommon</div>
          <div class="pointer mt-1 mr-1" [class.text-selected]="showRare" (click)="showRare = !showRare">Rare</div>
          <div class="pointer mt-1 mr-1" [class.text-selected]="showEpic" (click)="showEpic = !showEpic">Epic</div>
          <div class="pointer mt-1 mr-1" [class.text-selected]="showLegendary" (click)="showLegendary = !showLegendary">Legendary</div>
        </div>
      </div>
      <div class="mt-2 flex">
        <div class="width-60 flex-start">Jewels</div>
        <div class="flex-space-between flex-grow flex-wrap">
          <div class="pointer mt-1 mr-1" [class.text-selected]="show0jewels" (click)="show0jewels = !show0jewels">None</div>
          <div class="pointer mt-1 mr-1" [class.text-selected]="show1jewels" (click)="show1jewels = !show1jewels">One</div>
          <div class="pointer mt-1 mr-1" [class.text-selected]="show2jewels" (click)="show2jewels = !show2jewels">Two</div>
          <div class="pointer mt-1 mr-1" [class.text-selected]="show3jewels" (click)="show3jewels = !show3jewels">Three</div>
          <div class="pointer mt-1 mr-1" [class.text-selected]="show4jewels" (click)="show4jewels = !show4jewels">Four</div>
        </div>
      </div>
      <div class="mt-2 flex-end">
        <ion-button [fill]="gearForBreakdown().length == 0 ? 'outline' : 'solid'" size="small" color="danger" (click)="breakdown()" [disabled]="saving || gearForBreakdown().length == 0"><span *ngIf="gearForBreakdown().length > 0">
          {{gearForBreakdown().length}}x </span><ion-icon name="trash"></ion-icon>
        </ion-button>
        <ion-button fill="outline" size="small" color="danger" (click)="markAllForBreakdown()">Mark all</ion-button>
      </div>
    </ion-card-content>
  </ion-card>
  <ion-card>
    <ion-card-content>
      <ion-item *ngFor="let gear of getGear()">
        <div class="full-width flex-space-between">
          <gear-icon [gear]="gear" [type]="gear.type" (click)="showGearDetails(gear)" [class.pointer]="!gear.modificationInProgress"></gear-icon>
          <div class="ml-2 flex-vert gear-text flex-grow font-small">
            <div>
              {{converter.readableIdentifier(gear.gearQuality)}}
              {{converter.readableIdentifier(gear.type)}}
              <i>({{converter.readableIdentifier(gear.set)}})</i>
            </div>
            <div class="flex">
              <gear-stat [stat]="gear.stat" [value]="gear.statValue"></gear-stat>&nbsp;<i *ngIf="gear.modificationPerformed">(modified)</i>
            </div>
          </div>
          <div *ngIf="converter.rarityStars(gear.rarity) > model.progress.gearModificationRarity && converter.rarityStars(gear.rarity) > model.progress.gearBreakDownRarity">
            <i class="font-small color-grey">Upgrade Forge to modify or breakdown this piece</i>
          </div>
          <div *ngIf="converter.rarityStars(gear.rarity) > model.progress.gearModificationRarity && converter.rarityStars(gear.rarity) <= model.progress.gearBreakDownRarity">
            <i class="font-small color-grey">Upgrade Forge to modify this piece</i>
          </div>
          <div *ngIf="model.progress.gearModificationRarity >= converter.rarityStars(gear.rarity) && !gear.modificationInProgress">
            <ion-button fill="none" color="secondary" (click)="modificationSelection(gear, $event)" [disabled]="saving">Modify</ion-button>
          </div>
          <div *ngIf="gear.modificationInProgress" class="position-relative">
            <ion-button fill="none" color="secondary" (click)="openUpgradeModal()" [disabled]="saving">Modifying</ion-button>
            <div *ngIf="modificationFinished(gear)" class="avatar-bubble alert" style="top: 0; right: 0;">!</div>
          </div>
          <ion-button *ngIf="converter.rarityStars(gear.rarity) <= model.progress.gearBreakDownRarity" [fill]="gear.markedToBreakdown ? 'outline' : 'clear'" color="danger" (click)="gear.markedToBreakdown = !gear.markedToBreakdown" [disabled]="saving || gear.modificationInProgress">
            <ion-icon name="trash"></ion-icon>
          </ion-button>
          <div *ngIf="converter.rarityStars(gear.rarity) <= model.progress.gearModificationRarity && converter.rarityStars(gear.rarity) > model.progress.gearBreakDownRarity">
            <i class="font-small color-grey">Upgrade Forge to breakdown this piece</i>
          </div>
        </div>
      </ion-item>
    </ion-card-content>
  </ion-card>
</ion-content>
